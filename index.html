<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票持有管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jf-openhuninn-1.1/font.css">
    <style>
        /* --- 使用標準 CSS 定義樣式 (取代 @apply) --- */

        /* 基本樣式與字體 */
        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        body {
            font-family: 'jf-openhuninn', 'Noto Sans TC', sans-serif;
            background-color: #1f2937; /* gray-800 */
            color: #f3f4f6; /* gray-100 */
            margin: 0;
            padding: 1rem;
        }
        @media (min-width: 768px) {
            body { padding: 2rem; }
        }

        .container {
             max-width: 48rem; /* max-w-6xl approx */
             margin-left: auto;
             margin-right: auto;
             display: flex;
             flex-direction: column;
             gap: 2rem; /* space-y-8 */
        }

        /* 區塊容器 */
        .section-container {
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* space-y-4 */
        }

        /* 標題 */
        h1 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; text-align: center; color: #f3f4f6; }
        h2 { font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; color: #d1d5db; }

        /* 表單元素 */
        label { display: block; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500; color: #d1d5db; margin-bottom: 0.25rem; }
        input[type="text"], input[type="number"] {
            display: block;
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #4b5563; /* border-gray-600 */
            background-color: #1f2937; /* gray-800 */
            color: #f3f4f6; /* gray-100 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            font-size: 0.875rem; /* sm:text-sm */
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            line-height: 1.25rem; /* Ensure consistent height */
        }
        input:focus {
             border-color: #4f46e5; /* indigo-600 */
             outline: 2px solid transparent;
             outline-offset: 2px;
             box-shadow: 0 0 0 2px #4f46e5; /* Ring color */
        }

        /* 按鈕基礎樣式 (Standard CSS equivalent) */
        button, .button-like {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid transparent;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            cursor: pointer;
        }
        button:focus, .button-like:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
             box-shadow: 0 0 0 2px var(--tw-ring-offset-color, #1f2937), 0 0 0 4px var(--tw-ring-color); /* focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 */
        }
        button:disabled, .button-like:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 按鈕顏色分類 (Standard CSS) */
        .btn-data { background-color: #059669; --tw-ring-color: #10b981; padding: 0.375rem 0.75rem; font-size: 0.875rem; } /* bg-green-600, focus:ring-green-500, px-3 py-1.5 text-sm */
        .btn-data:hover { background-color: #047857; } /* hover:bg-green-700 */

        .btn-danger { background-color: #dc2626; --tw-ring-color: #ef4444; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.375rem; }
        .btn-danger:hover { background-color: #b91c1c; }

        .btn-undo { background-color: #f59e0b; --tw-ring-color: #fcd34d; color: #1f2937; padding: 0.375rem 0.75rem; font-size: 0.875rem; }
        .btn-undo:hover { background-color: #d97706; }

        /* 表格樣式 */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; min-width: 640px; border-collapse: collapse; border: 1px solid #4b5563; }
        th, td {
            font-size: 0.875rem;
            border: 1px solid #4b5563;
            padding: 0.5rem 0.75rem;
            white-space: nowrap;
            vertical-align: middle;
        }
        th {
            background-color: #4b5563;
            color: #f3f4f6;
            font-weight: 500;
        }
        td {
             color: #f3f4f6;
        }
        /* 表格 Footer */
        tfoot tr { background-color: #4b5563; font-weight: 500; color: #f3f4f6; }
        tfoot td { font-weight: 500; color: #f3f4f6; border: 1px solid #4b5563; padding: 0.5rem 0.75rem; }


        /* 文字對齊 (由 JS 加入 Utility Class) */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }

        /* 損益顏色 */
        .profit { color: #ef4444; } /* red-500 */
        .loss { color: #22c55e; } /* green-500 */

        /* 狀態文字 */
        .status-text { font-size: 0.75rem; line-height: 1rem; height: 1rem; margin-top: 0.25rem; }
        .status-gray { color: #9ca3af; } /* gray-400 */
        .status-green { color: #34d399; } /* green-400 */
        .status-blue { color: #60a5fa; } /* blue-400 */
        .status-purple { color: #a78bfa; } /* purple-400 */


        /* 行動裝置響應式 */
        @media (max-width: 768px) {
            .mobile-hide { display: none; }
            .action-col { width: 50px; }
            th, td { font-size: 0.8rem; padding: 0.5rem; }
        }
        /* Loading spinner */
        .loader {
            border: 2px solid #4b5563; border-top: 2px solid #6366f1; border-radius: 50%;
            width: 16px; height: 16px; animation: spin 1s linear infinite;
            display: inline-block; margin-left: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container">
        <div class="flex justify-between items-center">
             <h1 class="text-2xl font-bold text-center flex-grow">股票持有管理</h1>
        </div>

        <div class="section-container space-y-4">
            <div class="flex flex-wrap justify-between items-center gap-4">
                 <h2>我的持股</h2>
                 <div class="flex flex-wrap items-center gap-2">
                    <button id="refresh-daily-btn" class="btn-data">
                         更新收盤行情
                         <span id="refresh-spinner" class="hidden loader"></span>
                    </button>
                    <button id="export-btn" class="btn-data">匯出資料</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;">
                    <button id="import-btn" class="btn-data">匯入資料</button>
                    <button id="undo-remove-btn" class="btn-undo" style="display: none;">復原上次移除</button>
                 </div>
            </div>
             <p id="refresh-status" class="status-text status-blue"></p>
             <p id="data-status" class="status-text status-purple"></p>
             <div class="table-wrapper">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="text-center">股號</th>
                            <th class="text-center">名稱</th>
                            <th class="text-right">持有股數</th>
                            <th class="text-right">平均成本</th>
                            <th class="text-right">收盤價</th>
                            <th class="mobile-hide text-right">總成本</th>
                            <th class="text-right">總市值</th>
                            <th class="text-right">損益</th>
                            <th class="text-right">損益(%)</th>
                            <th class="action-col text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-body">
                        </tbody>
                     <tfoot>
                        <tr>
                            <td colspan="6" class="text-right pr-4 mobile-hide">總計</td>
                            <td colspan="5" class="text-left pl-4 md:hidden">總計</td>
                            <td id="total-market-value" class="text-right pr-4">0</td>
                            <td id="total-profit-loss" class="text-right pr-4">0</td>
                            <td id="total-profit-loss-percent" class="text-right pr-4">0.00%</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="section-container space-y-4">
             <h2>交易紀錄明細</h2>
             <div class="table-wrapper">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="text-center">日期</th>
                            <th class="text-center">股號</th>
                            <th class="text-center">名稱</th>
                            <th class="text-right">買入股數</th>
                            <th class="text-right">買入價格</th>
                            <th class="text-right">手續費(NTD)</th>
                            <th class="action-col text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="purchase-log-body">
                       </tbody>
                </table>
             </div>
        </div>

        <div class="flex justify-center mt-4">
             <button id="toggle-add-form-btn" class="btn-data">顯示新增持股區塊</button>
        </div>
        <div id="add-form-section" class="section-container space-y-4" style="display: none;">
            <h2>新增持股紀錄</h2>
            <div>
                <label for="add-symbol">股號*</label>
                <input type="text" id="add-symbol" placeholder="輸入股號後嘗試自動帶入名稱">
                <p id="symbol-status" class="status-text status-gray"></p>
            </div>
            <div>
                <label for="add-name">股票名稱*</label>
                <input type="text" id="add-name" placeholder="自動帶入或手動輸入">
            </div>
            <div>
                <label for="add-shares">買入股數*</label>
                <input type="number" id="add-shares" step="any" placeholder="例如: 1000 或 50">
            </div>
            <div>
                <label for="add-price">買入價格*</label>
                <input type="number" id="add-price" step="any" placeholder="例如: 600.5">
            </div>
            <div>
                <label for="add-fee-amount">手續費 (NTD)</label>
                <input type="number" id="add-fee-amount" step="any" value="0" placeholder="請輸入新台幣金額">
            </div>
            <div class="flex justify-start">
                 <button id="add-purchase-btn" class="btn-data">新增紀錄</button>
            </div>
            <p class="text-xs text-gray-400">* 為必填欄位。買入成本將計入手續費。</p>
            <p id="add-status" class="status-text status-green"></p>
        </div>

    </div>

    <script>
        // --- DOM 元素 ---
        const addSymbolInput = document.getElementById('add-symbol');
        const addNameInput = document.getElementById('add-name');
        const addSharesInput = document.getElementById('add-shares');
        const addPriceInput = document.getElementById('add-price');
        const addFeeAmountInput = document.getElementById('add-fee-amount');
        const addPurchaseBtn = document.getElementById('add-purchase-btn');
        const addStatus = document.getElementById('add-status');
        const symbolStatus = document.getElementById('symbol-status');

        const refreshDailyBtn = document.getElementById('refresh-daily-btn');
        const refreshSpinner = document.getElementById('refresh-spinner');
        const refreshStatus = document.getElementById('refresh-status');
        const dataStatus = document.getElementById('data-status');

        const portfolioBody = document.getElementById('portfolio-body');
        const totalMarketValueCell = document.getElementById('total-market-value');
        const totalProfitLossCell = document.getElementById('total-profit-loss');
        const totalProfitLossPercentCell = document.getElementById('total-profit-loss-percent');

        const purchaseLogBody = document.getElementById('purchase-log-body');

        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file');
        const undoRemoveBtn = document.getElementById('undo-remove-btn');

        const toggleAddFormBtn = document.getElementById('toggle-add-form-btn');
        const addFormSection = document.getElementById('add-form-section');


        // --- 全域變數 ---
        let portfolio = {}; // 記憶體中的投資組合副本
        let marketData = {}; // 行情資料
        let lastRemovedHolding = null; // 用於復原移除操作
        let db; // IndexedDB 資料庫實例

        // --- IndexedDB 設定 ---
        const DB_NAME = 'StockPortfolioDB_V2'; // 資料庫名稱 (可自訂)
        const STORE_NAME = 'HoldingsStore'; // 物件儲存區名稱 (可自訂)
        const DB_VERSION = 1; // 資料庫版本

        // --- Helper Function ---
        function padZero(num) {
            return num.toString().padStart(2, '0');
        }

        // --- IndexedDB 操作函式 ---

        // 初始化 IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                if (!('indexedDB' in window)) {
                    console.error("IndexedDB not supported");
                    alert('您的瀏覽器不支援 IndexedDB，無法儲存資料。');
                    reject('IndexedDB not supported');
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error("Database error: ", event.target.errorCode);
                    alert('無法開啟資料庫，資料將無法儲存。');
                    reject(event.target.errorCode);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log(`Database "${DB_NAME}" opened successfully.`);
                    resolve(db);
                };

                // 當資料庫需要升級時 (第一次建立或版本變更)
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    console.log(`Upgrading database to version ${DB_VERSION}...`);
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        // 建立物件儲存區，使用 'symbol' 作為主鍵
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'symbol' });
                        console.log(`Object store "${STORE_NAME}" created.`);
                        // 可以選擇性地建立索引，例如按名稱排序 (此處暫不需要)
                        // objectStore.createIndex('name', 'name', { unique: false });
                    }
                };
            });
        }

        // 從 IndexedDB 取得所有持股資料
        function getPortfolioFromDB() {
            return new Promise((resolve, reject) => {
                if (!db) { reject("Database not initialized"); return; }
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onerror = (event) => {
                    console.error("Error fetching data from DB:", event.target.errorCode);
                    reject(event.target.errorCode);
                };

                request.onsuccess = (event) => {
                    const holdingsArray = event.target.result || [];
                    // 將陣列轉換回物件形式，以 symbol 為 key
                    const portfolioObject = holdingsArray.reduce((obj, holding) => {
                        // 基本的資料驗證和修正
                        if (holding && holding.symbol) {
                             if (!Array.isArray(holding.purchases)) holding.purchases = [];
                             holding.purchases.forEach(p => { if (!p.date) p.date = 'N/A'; });
                             obj[holding.symbol] = holding;
                        } else {
                             console.warn("Skipping invalid holding data from DB:", holding);
                        }
                        return obj;
                    }, {});
                    console.log("Portfolio loaded from DB:", portfolioObject);
                    resolve(portfolioObject);
                };
            });
        }

        // 將單一持股加入或更新至 IndexedDB
        function saveHoldingToDB(holding) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("Database not initialized"); return; }
                if (!holding || !holding.symbol) { reject("Invalid holding data"); return; }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                // 使用 put 方法，如果 key (symbol) 已存在則更新，不存在則新增
                const request = objectStore.put(holding);

                request.onerror = (event) => {
                    console.error("Error saving holding to DB:", event.target.errorCode);
                    alert('儲存持股資料時發生錯誤。');
                    reject(event.target.errorCode);
                };

                request.onsuccess = (event) => {
                    console.log(`Holding ${holding.symbol} saved to DB.`);
                    resolve(event.target.result);
                };
            });
        }

        // 從 IndexedDB 移除單一持股
        function removeHoldingFromDB(symbol) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("Database not initialized"); return; }
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(symbol); // 根據主鍵 (symbol) 刪除

                request.onerror = (event) => {
                    console.error("Error removing holding from DB:", event.target.errorCode);
                    alert('移除持股資料時發生錯誤。');
                    reject(event.target.errorCode);
                };

                request.onsuccess = (event) => {
                    console.log(`Holding ${symbol} removed from DB.`);
                    resolve();
                };
            });
        }

        // 清空 IndexedDB 中的所有持股 (用於匯入時覆蓋)
        function clearHoldingsInDB() {
             return new Promise((resolve, reject) => {
                 if (!db) { reject("Database not initialized"); return; }
                 const transaction = db.transaction([STORE_NAME], 'readwrite');
                 const objectStore = transaction.objectStore(STORE_NAME);
                 const request = objectStore.clear(); // 清空儲存區

                 request.onerror = (event) => {
                     console.error("Error clearing holdings in DB:", event.target.errorCode);
                     alert('清空舊持股資料時發生錯誤。');
                     reject(event.target.errorCode);
                 };

                 request.onsuccess = (event) => {
                     console.log(`Store "${STORE_NAME}" cleared.`);
                     resolve();
                 };
             });
        }


        // --- 資料處理函式 (使用 IndexedDB) ---

        // (handleSymbolBlur 保持不變)
        function handleSymbolBlur() {
            const symbol = addSymbolInput.value.trim().toUpperCase();
            symbolStatus.textContent = '';
            if (!symbol) {
                addNameInput.value = '';
                return;
            }
            if (marketData && marketData[symbol] && marketData[symbol].name) {
                addNameInput.value = marketData[symbol].name;
                symbolStatus.textContent = '名稱已自動帶入 (來自上次更新)';
            } else {
                addNameInput.value = '';
                symbolStatus.textContent = '未找到名稱，請手動輸入或更新行情';
            }
             setTimeout(() => { symbolStatus.textContent = ''; }, 4000);
        }

        async function addPurchase() {
            const symbol = addSymbolInput.value.trim().toUpperCase();
            const name = addNameInput.value.trim();
            const shares = parseFloat(addSharesInput.value);
            const price = parseFloat(addPriceInput.value);
            const feeAmount = parseFloat(addFeeAmountInput.value);

            if (!symbol || !name || isNaN(shares) || shares <= 0 || isNaN(price) || price <= 0 || isNaN(feeAmount) || feeAmount < 0) {
                alert('請確保所有必填欄位 (*)\n都已正確填寫且數值有效。\n股數和價格必須大於 0，手續費不能為負。');
                return;
            }

            const purchaseCost = shares * price;
            const costWithFee = purchaseCost + feeAmount;
            const purchaseDate = new Date().toLocaleDateString(); // 使用本地日期格式

            // 從記憶體中取得或建立持股物件
            let holding = portfolio[symbol];
            if (!holding) {
                holding = { symbol: symbol, name: name, shares: 0, totalCost: 0, purchases: [] };
            }
            holding.name = name; // 更新名稱以防萬一
            holding.purchases.push({ date: purchaseDate, shares, price, commissionAmount: feeAmount, costWithFee });
            holding.shares += shares;
            holding.totalCost += costWithFee;

            try {
                await saveHoldingToDB(holding); // 將更新後的持股存回 DB
                portfolio[symbol] = holding; // 更新記憶體副本
                lastRemovedHolding = null; // 清除復原狀態
                undoRemoveBtn.style.display = 'none';
                renderPortfolio();
                renderPurchaseLog();

                addSymbolInput.value = '';
                addNameInput.value = '';
                addSharesInput.value = '';
                addPriceInput.value = '';
                addFeeAmountInput.value = '0';
                addStatus.textContent = `已新增 ${symbol} ${shares} 股購買紀錄。`;
                setTimeout(() => { addStatus.textContent = ''; }, 3000);
            } catch (error) {
                 console.error("Failed to save purchase:", error);
                 // 錯誤訊息已在 saveHoldingToDB 中 alert
            }
        }

        async function removeHolding(symbol) {
             const holdingToRemove = portfolio[symbol];
             if (holdingToRemove) {
                 // 深度複製一份資料用於復原
                 const removedData = JSON.parse(JSON.stringify(holdingToRemove));
                 if (confirm(`確定要移除 ${symbol} (${holdingToRemove.name}) 的所有持股紀錄嗎？此操作可復原一次。`)) {
                     try {
                         await removeHoldingFromDB(symbol); // 從 DB 移除
                         delete portfolio[symbol]; // 從記憶體移除
                         lastRemovedHolding = { symbol: symbol, data: removedData }; // 儲存復原狀態 (仍在記憶體)
                         undoRemoveBtn.style.display = 'inline-flex';
                         renderPortfolio();
                         renderPurchaseLog();
                         console.log(`Removed holding: ${symbol}. Undo state saved.`);
                         dataStatus.textContent = `已移除持股 ${symbol}。可點擊按鈕復原。`;
                         setTimeout(() => { dataStatus.textContent = ''; }, 3000);
                     } catch (error) {
                         console.error("Failed to remove holding:", error);
                         // 錯誤訊息已在 removeHoldingFromDB 中 alert
                     }
                 }
             } else {
                 console.warn(`Attempted to remove non-existent holding: ${symbol}`);
             }
        }

        async function undoLastRemove() {
            if (lastRemovedHolding && lastRemovedHolding.symbol && lastRemovedHolding.data) {
                try {
                    await saveHoldingToDB(lastRemovedHolding.data); // 將復原的資料存回 DB
                    portfolio[lastRemovedHolding.symbol] = lastRemovedHolding.data; // 更新記憶體
                    console.log(`Restored holding: ${lastRemovedHolding.symbol}`);
                    lastRemovedHolding = null; // 清除復原狀態
                    undoRemoveBtn.style.display = 'none';
                    renderPortfolio();
                    renderPurchaseLog();
                    dataStatus.textContent = '已復原上次移除的操作。';
                    setTimeout(() => { dataStatus.textContent = ''; }, 3000);
                } catch (error) {
                     console.error("Failed to undo remove:", error);
                     // 錯誤訊息已在 saveHoldingToDB 中 alert
                }
            } else {
                 console.warn("No remove action to undo.");
                 alert("沒有可復原的移除操作。");
                 undoRemoveBtn.style.display = 'none';
            }
        }

        async function deletePurchase(symbol, index) {
            let holding = portfolio[symbol];
            if (!holding || !Array.isArray(holding.purchases) || index < 0 || index >= holding.purchases.length) {
                 console.error(`Invalid symbol or index for deleting purchase: ${symbol}, ${index}`);
                 alert("刪除交易紀錄時發生錯誤。");
                 return;
            }

            const purchaseToRemove = holding.purchases[index];
            const purchaseInfo = `${purchaseToRemove.date} ${symbol} ${purchaseToRemove.shares}股 @ ${purchaseToRemove.price}`;

            if (confirm(`確定要刪除這筆交易紀錄嗎？\n${purchaseInfo}\n此操作無法復原。`)) {
                 // 更新持股資訊
                 holding.shares -= purchaseToRemove.shares;
                 holding.totalCost -= purchaseToRemove.costWithFee;
                 holding.purchases.splice(index, 1);

                 try {
                     if (holding.purchases.length === 0 || holding.shares <= 0) {
                         console.log(`Removing holding ${symbol} as it has no more purchases or shares.`);
                         // 如果刪除最後一筆交易，則移除整個持股
                         await removeHoldingFromDB(symbol);
                         delete portfolio[symbol]; // 從記憶體移除
                         // 允許復原整個被刪除的持股
                         lastRemovedHolding = { symbol: symbol, data: JSON.parse(JSON.stringify(holding)) };
                         undoRemoveBtn.style.display = 'inline-flex';
                     } else {
                         // 如果還有其他交易，則更新持股資料
                         await saveHoldingToDB(holding);
                         portfolio[symbol] = holding; // 更新記憶體
                         lastRemovedHolding = null; // 清除復原狀態
                         undoRemoveBtn.style.display = 'none';
                     }

                     renderPortfolio();
                     renderPurchaseLog();
                     console.log(`Deleted purchase for ${symbol} at index ${index}`);
                     dataStatus.textContent = `已刪除交易紀錄: ${symbol} #${index + 1}`;
                     setTimeout(() => { dataStatus.textContent = ''; }, 3000);

                 } catch (error) {
                     console.error("Failed to update holding after deleting purchase:", error);
                     // 錯誤訊息已在 DB 操作函式中 alert
                     // 可能需要考慮恢復記憶體中的狀態
                     portfolio = await getPortfolioFromDB(); // 嘗試從 DB 重新同步
                     renderPortfolio();
                     renderPurchaseLog();
                 }
            }
        }


        // (fetchDailyClosingPrices, isValidNumber 保持不變)
        async function fetchDailyClosingPrices() {
            refreshDailyBtn.disabled = true;
            refreshSpinner.classList.remove('hidden');
            refreshStatus.textContent = '正在更新收盤行情...';
            lastRemovedHolding = null; // 清除復原狀態，避免誤操作
            undoRemoveBtn.style.display = 'none';

            const apiUrl = "https://www.twse.com.tw/exchangeReport/STOCK_DAY_ALL?response=open_data";

            try {
                // 添加時間戳以避免快取
                const response = await fetch(apiUrl + '&_=' + new Date().getTime());
                if (!response.ok) {
                    console.error(`API Error: ${response.status} ${response.statusText}`);
                    let errorText = `API 請求失敗 (${response.status})。可能是證交所主機忙碌或網址失效。`;
                    if (response.status === 404) errorText = 'API 網址錯誤 (404 Not Found)。';
                    if (response.status >= 500) errorText = '證交所伺服器錯誤，請稍後再試。';
                    throw new Error(errorText);
                }
                const textData = await response.text();
                const lines = textData.split('\n');
                let dataStarted = false;
                let parsedCount = 0;
                let updatedMarketData = {};

                // 尋找資料起始行（通常是 "證券代號","證券名稱",...）
                 const headerIndex = lines.findIndex(line => line.includes('"證券代號"'));
                 if (headerIndex === -1) {
                     console.warn("找不到預期的資料標頭，可能格式已變更。");
                     // 嘗試從頭解析，但可能不準確
                 }

                for (let i = headerIndex + 1; i < lines.length; i++) {
                     const line = lines[i];
                     const trimmedLine = line.trim().replace(/=/g, ""); // 移除等號
                     if (!trimmedLine) continue;

                     // 使用更穩健的方式分割 CSV，處理可能包含逗號的名稱
                     const parts = [];
                     let currentPart = '';
                     let inQuotes = false;
                     for (let char of trimmedLine) {
                         if (char === '"' && !inQuotes) {
                             inQuotes = true;
                         } else if (char === '"' && inQuotes) {
                             inQuotes = false;
                         } else if (char === ',' && !inQuotes) {
                             parts.push(currentPart.trim());
                             currentPart = '';
                         } else {
                             currentPart += char;
                         }
                     }
                     parts.push(currentPart.trim()); // 加入最後一部分

                     // 檢查代號格式和欄位數量
                     if (parts.length >= 8 && parts[0].match(/^\d{4,6}$/)) {
                         const symbol = parts[0];
                         const name = parts[1];
                         const closingPriceStr = parts[7]; // 第八欄是收盤價

                         if (isValidNumber(closingPriceStr)) {
                             try {
                                 updatedMarketData[symbol] = { name: name, closingPrice: parseFloat(closingPriceStr.replace(/,/g, '')) };
                                 parsedCount++;
                             } catch (e) { console.warn(`無法解析價格: ${symbol} - ${closingPriceStr}`); }
                         } else {
                             // 如果價格無效，仍然記錄名稱，價格設為 0 或上次的值（如果有的話）
                             if (!updatedMarketData[symbol]) {
                                 updatedMarketData[symbol] = { name: name, closingPrice: (marketData[symbol]?.closingPrice || 0.0) };
                             } else {
                                 updatedMarketData[symbol].name = name; // 更新名稱
                             }
                             console.warn(`無效或無收盤價資料: ${symbol} (${name}) - ${closingPriceStr}`);
                         }
                     }
                 }

                if (parsedCount === 0 && Object.keys(updatedMarketData).length > 0) {
                     console.warn("成功解析部分資料，但沒有有效的收盤價。");
                     refreshStatus.textContent = `行情更新完成，但未找到有效的收盤價資料。`;
                } else if (parsedCount > 0) {
                     refreshStatus.textContent = `收盤行情更新成功！共處理 ${parsedCount} 筆有效價格資料。`;
                } else {
                     refreshStatus.textContent = `未從 API 回應中找到有效的股票資料。`;
                }

                marketData = updatedMarketData; // Update global market data
                console.log("Parsed market data:", marketData);
                setTimeout(() => { refreshStatus.textContent = ''; }, 5000);
                return true; // 表示 API 請求成功（但不保證有資料）

            } catch (error) {
                console.error("獲取或解析行情資料時發生錯誤:", error);
                refreshStatus.textContent = `錯誤: ${error.message}. 請檢查網路連線或稍後再試。`;
                 return false; // 表示 API 請求或解析失敗
            } finally {
                refreshDailyBtn.disabled = false;
                refreshSpinner.classList.add('hidden');
            }
        }

        function isValidNumber(str) {
            if (str == null || typeof str !== 'string') return false;
            const trimmedStr = str.trim();
            if (trimmedStr === "" || trimmedStr === "--" || trimmedStr.toLowerCase().includes('x') || trimmedStr.includes('除')) return false;
            // 檢查是否只包含數字、逗號、小數點和可能的負號
            if (!/^-?[\d,]*\.?\d*$/.test(trimmedStr)) return false;
            try {
                const num = parseFloat(trimmedStr.replace(/,/g, ''));
                return !isNaN(num) && isFinite(num); // 確保是有效數字且非無窮大
            } catch (e) { return false; }
        }


        // --- Rendering Functions (保持不變，從記憶體 portfolio 渲染) ---
        function renderPortfolio() {
            portfolioBody.innerHTML = '';
            let grandTotalMarketValue = 0;
            let grandTotalCost = 0;
            const symbols = Object.keys(portfolio).sort();
            const tdBase = "px-3 py-2 text-sm border border-gray-600 whitespace-nowrap";

            if (symbols.length === 0) {
                 portfolioBody.innerHTML = `<tr><td colspan="10" class="${tdBase} text-center text-gray-400 py-4">目前沒有持股資料</td></tr>`;
                 totalMarketValueCell.textContent = '0';
                 totalProfitLossCell.textContent = '0';
                 totalProfitLossPercentCell.textContent = '0.00%';
                 const footerCellClasses = "px-3 py-2 text-sm border border-gray-600 text-right pr-4";
                 totalMarketValueCell.className = footerCellClasses;
                 totalProfitLossCell.className = footerCellClasses;
                 totalProfitLossPercentCell.className = footerCellClasses;
                 return;
            }

            symbols.forEach(symbol => {
                const stock = portfolio[symbol];
                 if (!stock || typeof stock !== 'object' || isNaN(stock.shares) || isNaN(stock.totalCost)) {
                     console.warn(`Invalid data found for symbol ${symbol}, skipping render.`);
                     return;
                 }

                const avgPrice = stock.shares > 0 ? (stock.totalCost / stock.shares) : 0;
                const totalCost = stock.totalCost;
                let closingPrice = 0.0;
                let displayName = stock.name || 'N/A';
                let marketValue = 0;
                let profitLoss = 0;
                let profitLossPercent = 0;
                let plClass = '';
                const dailyData = marketData[symbol];
                if (dailyData) {
                    displayName = dailyData.name || stock.name; // 優先使用 API 的名稱
                    closingPrice = dailyData.closingPrice || 0.0;
                }

                if (closingPrice > 0 && stock.shares > 0) {
                    marketValue = stock.shares * closingPrice;
                    profitLoss = marketValue - totalCost;
                    if (totalCost !== 0) { // 避免除以零
                         profitLossPercent = (profitLoss / totalCost) * 100;
                    } else if (marketValue > 0) {
                         profitLossPercent = Infinity; // 成本為零，市值大於零 -> 無限獲利
                    } else {
                         profitLossPercent = 0; // 成本為零，市值也為零
                    }
                    plClass = profitLoss >= 0 ? 'profit' : 'loss';
                    grandTotalMarketValue += marketValue;
                }
                 grandTotalCost += totalCost;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="${tdBase} text-center">${symbol}</td>
                    <td class="${tdBase} text-center">${displayName}</td>
                    <td class="${tdBase} text-right">${stock.shares.toLocaleString()}</td>
                    <td class="${tdBase} text-right">${avgPrice.toFixed(2)}</td>
                    <td class="${tdBase} text-right">${closingPrice > 0 ? closingPrice.toFixed(2) : 'N/A'}</td>
                    <td class="${tdBase} mobile-hide text-right">${totalCost.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                    <td class="${tdBase} text-right">${marketValue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                    <td class="${tdBase} text-right ${plClass}">${profitLoss.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                    <td class="${tdBase} text-right ${plClass}">${isFinite(profitLossPercent) ? profitLossPercent.toFixed(2) + '%' : (profitLoss > 0 ? '∞' : '-∞')}</td>
                    <td class="${tdBase} text-center action-col"><button class="btn-danger" data-symbol="${symbol}">移除</button></td>
                `;
                portfolioBody.appendChild(row);
            });

            // Update totals row
            const grandTotalProfitLoss = grandTotalMarketValue - grandTotalCost;
            let grandTotalProfitLossPercent = 0;
             if (grandTotalCost !== 0) { // 避免除以零
                 grandTotalProfitLossPercent = (grandTotalProfitLoss / grandTotalCost) * 100;
             } else if (grandTotalMarketValue > 0) {
                 grandTotalProfitLossPercent = Infinity;
             }
            let totalPlClass = grandTotalProfitLoss >= 0 ? 'profit' : 'loss';
            const footerCellClasses = "px-3 py-2 text-sm border border-gray-600 text-right pr-4";
            totalMarketValueCell.textContent = grandTotalMarketValue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            totalProfitLossCell.textContent = grandTotalProfitLoss.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            totalProfitLossPercentCell.textContent = isFinite(grandTotalProfitLossPercent) ? `${grandTotalProfitLossPercent.toFixed(2)}%` : (grandTotalProfitLoss > 0 ? '∞' : '-∞');
            totalMarketValueCell.className = footerCellClasses;
            totalProfitLossCell.className = `${footerCellClasses} ${totalPlClass}`;
            totalProfitLossPercentCell.className = `${footerCellClasses} ${totalPlClass}`;
        }

        function renderPurchaseLog() {
            purchaseLogBody.innerHTML = '';
            const symbols = Object.keys(portfolio).sort();
            const tdBaseClasses = "px-3 py-2 text-sm border border-gray-600 whitespace-nowrap";
            const tdAction = `${tdBaseClasses} action-col text-center`;

            if (symbols.length === 0) {
                 purchaseLogBody.innerHTML = `<tr><td colspan="7" class="${tdBaseClasses} text-center text-gray-400 py-4">沒有交易紀錄</td></tr>`;
                 return;
            }

            let hasPurchases = false;
            symbols.forEach(symbol => {
                 const holding = portfolio[symbol];
                 if (holding && Array.isArray(holding.purchases) && holding.purchases.length > 0) {
                     // 按照日期排序交易紀錄，如果日期無效則排在前面
                     const sortedPurchases = holding.purchases.sort((a, b) => {
                         const dateA = a.date && !isNaN(new Date(a.date)) ? new Date(a.date) : new Date(0); // 無效日期視為最早
                         const dateB = b.date && !isNaN(new Date(b.date)) ? new Date(b.date) : new Date(0);
                         return dateA - dateB;
                     });

                     sortedPurchases.forEach((purchase, index) => {
                         hasPurchases = true;
                         const row = document.createElement('tr');
                         row.innerHTML = `
                            <td class="${tdBaseClasses} text-center">${purchase.date || 'N/A'}</td>
                            <td class="${tdBaseClasses} text-center">${symbol}</td>
                            <td class="${tdBaseClasses} text-center">${holding.name || 'N/A'}</td>
                            <td class="${tdBaseClasses} text-right">${purchase.shares?.toLocaleString() || 'N/A'}</td>
                            <td class="${tdBaseClasses} text-right">${purchase.price?.toFixed(2) || 'N/A'}</td>
                            <td class="${tdBaseClasses} text-right">${purchase.commissionAmount?.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) || '0'}</td>
                            <td class="${tdAction}">
                                <button class="btn-danger delete-purchase-btn" data-symbol="${symbol}" data-index="${index}">刪除</button>
                            </td>
                         `;
                         purchaseLogBody.appendChild(row);
                     });
                 }
            });

             if (!hasPurchases) {
                 purchaseLogBody.innerHTML = `<tr><td colspan="7" class="${tdBaseClasses} text-center text-gray-400 py-4">沒有交易紀錄</td></tr>`;
             }
        }

        // --- 匯出/匯入 功能 (匯出從記憶體讀取，匯入寫入 IndexedDB) ---

        // 匯出功能：讀取記憶體中的 portfolio
        function exportData() {
            if (Object.keys(portfolio).length === 0) { alert("沒有資料可匯出。"); return; }
            try {
                const now = new Date();
                const month = padZero(now.getMonth() + 1);
                const day = padZero(now.getDate());
                const hours = padZero(now.getHours());
                const minutes = padZero(now.getMinutes());
                const timestamp = `${month}${day}${hours}${minutes}`;
                const filename = `RICE_portfolio_${timestamp}.json`;
                // 將記憶體中的 portfolio 物件轉換為 JSON
                const jsonString = JSON.stringify(portfolio, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                dataStatus.textContent = `資料已成功匯出為 ${filename}！`;
                console.log("Data exported as:", filename);
            } catch (e) {
                 console.error("Export failed:", e); dataStatus.textContent = '資料匯出失敗。'; alert("資料匯出失敗：" + e.message);
            }
             lastRemovedHolding = null; undoRemoveBtn.style.display = 'none';
             setTimeout(() => { dataStatus.textContent = ''; }, 3000);
        }

        // 匯入功能：讀取檔案，驗證後寫入 IndexedDB
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.toLowerCase().endsWith('.json')) {
                 alert("請選擇一個 .json 格式的檔案。"); event.target.value = null; return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedPortfolioObject = JSON.parse(e.target.result);
                    // 驗證匯入的資料結構是否為物件
                    if (typeof importedPortfolioObject !== 'object' || importedPortfolioObject === null || Array.isArray(importedPortfolioObject)) {
                        throw new Error("匯入的檔案格式不符，根層級必須是一個物件 (以股票代號為 key)。");
                    }

                    // 驗證每個持股的結構
                    Object.entries(importedPortfolioObject).forEach(([symbol, holding]) => {
                         if (!holding || typeof holding.shares !== 'number' || typeof holding.totalCost !== 'number' || !Array.isArray(holding.purchases)) {
                             throw new Error(`持股 ${symbol} 的資料結構不完整或錯誤。`);
                         }
                         // 確保 symbol 和 key 一致
                         if (holding.symbol !== symbol) {
                              console.warn(`修正持股 ${symbol} 的 symbol 欄位以符合 key。`);
                              holding.symbol = symbol;
                         }
                         // 修正日期格式 (可選，若需要)
                         holding.purchases.forEach(p => { if (!p.date) p.date = 'N/A'; });
                     });

                    if (confirm("確定要匯入資料嗎？\n這將會覆蓋您目前所有的持股資料！")) {
                        dataStatus.textContent = '正在清空舊資料並匯入新資料...';
                        await clearHoldingsInDB(); // 清空 DB
                        portfolio = {}; // 清空記憶體
                        marketData = {}; // 清空行情
                        lastRemovedHolding = null;
                        undoRemoveBtn.style.display = 'none';

                        // 逐一將匯入的持股寫入 DB
                        const savePromises = Object.values(importedPortfolioObject).map(holding => saveHoldingToDB(holding));
                        await Promise.all(savePromises);

                        portfolio = importedPortfolioObject; // 更新記憶體副本
                        dataStatus.textContent = '資料已成功匯入！正在更新行情...';
                        await fetchDailyClosingPrices(); // 更新行情
                        renderPortfolio(); // 渲染畫面
                        renderPurchaseLog();
                        dataStatus.textContent = '資料已成功匯入並更新行情！';
                        console.log("Data imported:", portfolio);
                    }
                } catch (error) {
                    console.error("Import failed:", error);
                    dataStatus.textContent = '資料匯入失敗：' + error.message;
                    alert("資料匯入失敗：\n" + error.message + "\n請確保檔案是正確的 JSON 格式且結構無誤。");
                } finally {
                     event.target.value = null; // 清空 file input 以允許再次選擇同一個檔案
                     setTimeout(() => { dataStatus.textContent = ''; }, 5000);
                }
            };
            reader.onerror = function() {
                 console.error("File reading error:", reader.error);
                 dataStatus.textContent = '讀取檔案時發生錯誤。';
                 alert("讀取檔案時發生錯誤。");
                 event.target.value = null;
                 setTimeout(() => { dataStatus.textContent = ''; }, 3000);
            };
            reader.readAsText(file);
        }

        // --- 切換新增表單顯示 (保持不變) ---
        function toggleAddForm() {
            if (addFormSection.style.display === 'none') {
                addFormSection.style.display = 'block';
                toggleAddFormBtn.textContent = '隱藏新增持股區塊';
            } else {
                addFormSection.style.display = 'none';
                toggleAddFormBtn.textContent = '顯示新增持股區塊';
            }
        }

        // --- 事件監聽器 (部分更新以使用 async) ---
        addSymbolInput.addEventListener('blur', handleSymbolBlur);
        addPurchaseBtn.addEventListener('click', addPurchase); // addPurchase 已是 async
        refreshDailyBtn.addEventListener('click', async () => {
            await fetchDailyClosingPrices();
            renderPortfolio(); // 使用更新後的 marketData 重新渲染
            // renderPurchaseLog(); // 交易紀錄通常不需要在更新行情後重繪
        });
        exportBtn.addEventListener('click', exportData);
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importData); // importData 已是 async
        undoRemoveBtn.addEventListener('click', undoLastRemove); // undoLastRemove 已是 async
        toggleAddFormBtn.addEventListener('click', toggleAddForm);

        // 使用事件委派監聽持股列表中的移除按鈕
        portfolioBody.addEventListener('click', (event) => {
             const button = event.target.closest('button.btn-danger');
             if (button && button.hasAttribute('data-symbol')) {
                 const symbolToRemove = button.getAttribute('data-symbol');
                 removeHolding(symbolToRemove); // removeHolding 已是 async
             }
        });

        // 使用事件委派監聽交易紀錄列表中的刪除按鈕
        purchaseLogBody.addEventListener('click', (event) => {
             const button = event.target.closest('button.delete-purchase-btn');
             if (button && button.hasAttribute('data-symbol') && button.hasAttribute('data-index')) {
                 const symbol = button.getAttribute('data-symbol');
                 const index = parseInt(button.getAttribute('data-index'), 10);
                 if (symbol && !isNaN(index)) {
                     deletePurchase(symbol, index); // deletePurchase 已是 async
                 }
             }
        });


        // --- 初始載入 ---
        document.addEventListener('DOMContentLoaded', async () => {
             try {
                 await initDB(); // 初始化 IndexedDB
                 portfolio = await getPortfolioFromDB(); // 從 DB 載入資料
                 renderPortfolio(); // 渲染初始持股
                 renderPurchaseLog(); // 渲染初始交易紀錄
                 const fetchSuccess = await fetchDailyClosingPrices(); // 獲取行情
                 if(fetchSuccess) {
                     renderPortfolio(); // 使用行情更新持股顯示
                 } else {
                     refreshStatus.textContent = '頁面載入時行情更新失敗，請稍後手動更新。';
                 }
             } catch (error) {
                  console.error("Initialization failed:", error);
                  // 錯誤訊息已在相關函式中 alert
                  // 可以考慮顯示一個更持久的錯誤訊息在頁面上
                  dataStatus.textContent = '應用程式初始化失敗，部分功能可能無法使用。';
             }
        });

    </script>
</body>
</html>
